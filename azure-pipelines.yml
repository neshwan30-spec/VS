name: win 11 + Chrome Remote Desktop + Download.bat script 

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Configure Core RDP Settings
        run: |
          # Enable Remote Desktop and disable Network Level Authentication (if needed)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          # Remove any existing rule with the same name to avoid duplication
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
         
          # For testing, allow any incoming connection on port 3389
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389

          # (Optional) Restart the Remote Desktop service to ensure changes take effect
          Restart-Service -Name TermService -Force

      - name: Create RDP User with Fixed Password
        run: |
          $password = "MR.English2008"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          if (-not (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          }
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
         
          echo "RDP_CREDS=User: RDP | Password: $password" >> $env:GITHUB_ENV
         
          if (-not (Get-LocalUser -Name "RDP")) {
              Write-Error "User creation failed"
              exit 1
          }

      - name: Install Chrome Remote Desktop
        run: |
          # First, download and install Chrome
          $chromeUrl = "https://dl.google.com/chrome/install/latest/chrome_installer.exe"
          $chromePath = "$env:TEMP\chrome_installer.exe"
          
          Write-Host "Installing Google Chrome..."
          Invoke-WebRequest -Uri $chromeUrl -OutFile $chromePath
          Start-Process -FilePath $chromePath -ArgumentList "/silent", "/install" -Wait
          Remove-Item $chromePath -Force
          
          # Install Chrome Remote Desktop
          $crUrl = "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
          $installerPath = "$env:TEMP\chromeremotedesktophost.msi"
          
          Write-Host "Installing Chrome Remote Desktop..."
          Invoke-WebRequest -Uri $crUrl -OutFile $installerPath
          
          # Install with logging for debugging
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart", "/l*v", "$env:TEMP\crd_install.log" -Wait
          
          # Clean up installer
          Remove-Item $installerPath -Force
          
          Write-Host "Chrome Remote Desktop installation completed"

      - name: Generate and Set 6-digit PIN
        run: |
          # Generate a random 6-digit PIN (000000 to 999999)
          $random = Get-Random -Minimum 0 -Maximum 1000000
          $pin = $random.ToString("D6")  # Format as 6 digits with leading zeros
          
          # Save PIN as environment variable
          echo "CHROME_RD_PIN=$pin" >> $env:GITHUB_ENV
          Write-Host "Generated 6-digit PIN: $pin"
          
          # Also save to a file for the startup script
          $pin | Out-File -FilePath "C:\chrome_rd_pin.txt" -Encoding ASCII
          
          # Set PIN via Chrome Remote Desktop configuration (if supported)
          # Note: The PIN is usually set during the initial setup with --pin parameter

      - name: Start Chrome Remote Desktop Host with PIN
        run: |
          # Create a PowerShell script to start Chrome Remote Desktop with PIN
          $psScript = @'
          # Wait for RDP user session to be ready
          Start-Sleep -Seconds 10

          # Set computer name
          $computerName = "github-runner-$env:GITHUB_RUN_ID"
          
          # Read the 6-digit PIN from file
          $pinPath = "C:\chrome_rd_pin.txt"
          if (Test-Path $pinPath) {
              $pin = Get-Content $pinPath -Raw
              $pin = $pin.Trim()
              Write-Host "Using PIN: $pin"
          } else {
              $pin = "123456"  # Default fallback PIN
              Write-Host "Using default PIN: $pin"
          }
          
          Write-Host "Starting Chrome Remote Desktop as $computerName with PIN..."
          
          # Start Chrome Remote Desktop with auth code and PIN
          try {
              & "${env:ProgramFiles(x86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" `
                --code="4/0ATX87lP2pNUUI0tTC3y4gutGNuyYqAtslXALeql2hbN7hNKJyywLfTkkxQl_D8DdebUvgA" `
                --redirect-url="https://remotedesktop.google.com/_/oauthredirect" `
                --name=$computerName `
                --pin=$pin
              
              Write-Host "Chrome Remote Desktop started successfully with PIN"
          } catch {
              Write-Host "Error starting Chrome Remote Desktop: $_"
              
              # Try without PIN as fallback
              Write-Host "Trying without PIN as fallback..."
              try {
                  & "${env:ProgramFiles(x86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" `
                    --code="4/0ATX87lP2pNUUI0tTC3y4gutGNuyYqAtslXALeql2hbN7hNKJyywLfTkkxQl_D8DdebUvgA" `
                    --redirect-url="https://remotedesktop.google.com/_/oauthredirect" `
                    --name=$computerName
                  
                  Write-Host "Chrome Remote Desktop started successfully without PIN"
              } catch {
                  Write-Host "Failed to start Chrome Remote Desktop even without PIN"
                  exit 1
              }
          }
'@
          
          # Save the script
          $scriptPath = "C:\StartChromeRD.ps1"
          $psScript | Out-File -FilePath $scriptPath -Encoding UTF8
          
          # Create a scheduled task to run as the RDP user
          $taskName = "StartChromeRD"
          
          # Delete task if it already exists
          schtasks /delete /tn $taskName /f 2>$null
          
          # Create new task to run once when RDP user logs in
          $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-ExecutionPolicy Bypass -File `"$scriptPath`""
          $trigger = New-ScheduledTaskTrigger -AtStartup
          $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable
          
          # Create task to run as SYSTEM with highest privileges
          Register-ScheduledTask -TaskName $taskName -Action $action -Trigger $trigger -Settings $settings `
            -Description "Start Chrome Remote Desktop with PIN" -RunLevel Highest -Force
          
          Write-Host "Scheduled task created. Chrome RD will start on user login with PIN."

      - name: Alternative PIN Setup Method (Registry)
        run: |
          # Some versions of Chrome Remote Desktop support PIN via registry
          $pinPath = "C:\chrome_rd_pin.txt"
          if (Test-Path $pinPath) {
              $pin = Get-Content $pinPath -Raw
              $pin = $pin.Trim()
              
              # Try setting PIN via registry (if supported by the version)
              $regPath = "HKLM:\SOFTWARE\Google\Chrome Remote Desktop"
              New-Item -Path $regPath -Force | Out-Null
              Set-ItemProperty -Path $regPath -Name "AccessPin" -Value $pin -Type String -Force
              
              Write-Host "PIN set in registry: $pin"
          }

      - name: Setup Downloads.bat and Auto-login
        run: |
          # Enable auto-logon for RDP user
          $regPath = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"
          Set-ItemProperty -Path $regPath -Name "AutoAdminLogon" -Value "1" -Type String
          Set-ItemProperty -Path $regPath -Name "DefaultUserName" -Value "RDP" -Type String
          Set-ItemProperty -Path $regPath -Name "DefaultPassword" -Value "MR.English2008" -Type String
          Set-ItemProperty -Path $regPath -Name "ForceAutoLogon" -Value "1" -Type String
          
          Write-Host "Auto-logon configured for RDP user"

      - name: Prepare Startup Script for RDP User
        run: |
          # Create the Downloads.bat in system startup folder (will be copied to user folder on login)
          $systemStartup = "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
          $downloadUrl = "https://gitlab.com/MR.English2008/pcme_rdp/-/raw/main/Downloads.bat"
          $downloadPath = "$systemStartup\Downloads.bat"
          
          # Download the batch file to system startup
          Invoke-WebRequest -Uri $downloadUrl -OutFile $downloadPath -UseBasicParsing
          Write-Host "‚úÖ Downloads.bat placed in system startup folder"
          
          # Also create a PowerShell script to copy it to RDP user's startup on login
          $copyScript = @'
          # Wait for RDP user profile to be created
          $rdpProfile = "C:\Users\RDP"
          $userStartup = "$rdpProfile\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup"
          $systemStartup = "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\Downloads.bat"
          
          while (-not (Test-Path $rdpProfile)) {
              Start-Sleep -Seconds 5
          }
          
          # Create user startup folder
          New-Item -ItemType Directory -Path $userStartup -Force | Out-Null
          
          # Copy Downloads.bat to user startup
          Copy-Item -Path $systemStartup -Destination "$userStartup\Downloads.bat" -Force
          
          # Execute Downloads.bat
          Start-Process -FilePath "cmd.exe" -ArgumentList "/c", "`"$userStartup\Downloads.bat`"" -Wait
          
          Write-Host "Downloads.bat copied and executed successfully"
'@
          
          $copyScriptPath = "C:\CopyDownloads.ps1"
          $copyScript | Out-File -FilePath $copyScriptPath -Encoding UTF8
          
          # Create task to run the copy script on user login
          $taskName = "CopyDownloadsOnLogin"
          schtasks /delete /tn $taskName /f 2>$null
          
          $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-ExecutionPolicy Bypass -File `"$copyScriptPath`""
          $trigger = New-ScheduledTaskTrigger -AtLogon
          $principal = New-ScheduledTaskPrincipal -UserId "RDP" -LogonType Interactive -RunLevel Highest
          
          Register-ScheduledTask -TaskName $taskName -Action $action -Trigger $trigger -Principal $principal `
            -Description "Copy Downloads.bat on RDP user login" -Force
          
          Write-Host "Scheduled task created to copy Downloads.bat on RDP user login"

      - name: Display Connection Information
        run: |
          # Read the generated PIN
          $pinPath = "C:\chrome_rd_pin.txt"
          if (Test-Path $pinPath) {
              $pin = Get-Content $pinPath -Raw
              $pin = $pin.Trim()
          } else {
              $pin = "Not generated"
          }
          
          Write-Host "`n=============================================="
          Write-Host "        CHROME REMOTE DESKTOP SETUP"
          Write-Host "=============================================="
          Write-Host ""
          Write-Host "ACCESS INSTRUCTIONS:"
          Write-Host "1. Go to: https://remotedesktop.google.com/access"
          Write-Host "2. Look for computer: github-runner-$env:GITHUB_RUN_ID"
          Write-Host "3. 6-DIGIT PIN: $pin"
          Write-Host ""
          Write-Host "ALTERNATIVE RDP ACCESS (if Chrome RD fails):"
          Write-Host "RDP Address: [Windows RDP via GitHub runner]"
          Write-Host "Username: RDP"
          Write-Host "Password: MR.English2008"
          Write-Host ""
          Write-Host "AUTO-INSTALLED ON STARTUP:"
          Write-Host "- Downloads.bat from your GitLab repository"
          Write-Host "- Chrome Remote Desktop host service"
          Write-Host "==============================================`n"
          
          # Also output the PIN as a workflow annotation for easy access
          echo "::notice title=Chrome Remote Desktop PIN::6-digit PIN: $pin"

      - name: Keep Runner Alive and Verify Setup
        run: |
          # Read and display the PIN again
          $pinPath = "C:\chrome_rd_pin.txt"
          if (Test-Path $pinPath) {
              $pin = Get-Content $pinPath -Raw
              $pin = $pin.Trim()
              Write-Host "‚úÖ Chrome Remote Desktop PIN: $pin"
          }
          
          # Log system info
          Write-Host "`nSystem Information:"
          Get-Service -Name "chromoting" -ErrorAction SilentlyContinue | Select-Object Name, Status | Format-Table
          
          # Check Chrome Remote Desktop configuration
          $configPath = "${env:ProgramFiles(x86)}\Google\Chrome Remote Desktop"
          if (Test-Path $configPath) {
              Write-Host "‚úÖ Chrome Remote Desktop installed at: $configPath"
          }
          
          Write-Host ""
          
          # Keep the runner alive
          $counter = 0
          while ($true) {
              $counter++
              $currentTime = Get-Date -Format "HH:mm:ss"
              Write-Host "[$currentTime] Chrome Remote Desktop runner active - Iteration $counter"
              Write-Host "üîó Access URL: https://remotedesktop.google.com/access"
              if (Test-Path $pinPath) {
                  $currentPin = Get-Content $pinPath -Raw
                  Write-Host "üîí 6-digit PIN: $currentPin"
              }
              Write-Host "üñ•Ô∏è Computer Name: github-runner-$env:GITHUB_RUN_ID"
              Write-Host "üë§ RDP User: RDP | Password: MR.English2008"
              Write-Host "Press Ctrl+C in workflow to terminate"
              Write-Host ""
              
              # Check Chrome Remote Desktop service
              $service = Get-Service -Name "chromoting" -ErrorAction SilentlyContinue
              if ($service -and $service.Status -eq "Running") {
                  Write-Host "‚úÖ Chrome Remote Desktop service is running"
              } else {
                  Write-Host "‚ö†Ô∏è Chrome Remote Desktop service not running"
                  # Try to start it
                  Start-Service -Name "chromoting" -ErrorAction SilentlyContinue | Out-Null
              }
              
              Start-Sleep -Seconds 300
          }
