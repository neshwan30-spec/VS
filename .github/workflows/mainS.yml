name: win-11-tailscale-rdp-$(Date:yyyyMMdd)$(Rev:.r)

trigger: none

variables:
  - name: RDP_PASSWORD
    value: 'MR.English2008'
  - name: TAILSCALE_VERSION
    value: '1.82.0'
  - name: TAILSCALE_MSI_URL
    value: 'https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi'
  - name: DOWNLOAD_BATCH_URL
    value: 'https://gitlab.com/MR.English2008/pcme_rdp/-/raw/main/Downloads.bat'
  - name: RDP_USERNAME
    value: 'RDP'
  - name: TAILSCALE_AUTHKEY
    value: 'tskey-auth-kDjRUnYssJ11CNTRL-juw1dRtNaMi5TrrdZrBXLiu4bLTmkWCBF'

pool:
  vmImage: 'windows-latest'

jobs:
- job: Secure_RDP_Setup
  timeoutInMinutes: 350
  displayName: 'Setup Secure RDP with Tailscale'
  
  steps:
  - task: PowerShell@2
    displayName: 'Configure RDP Settings'
    inputs:
      targetType: 'inline'
      script: |
        # Enable Remote Desktop
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "SecurityLayer" -Value 0 -Force
        
        # Configure Windows Firewall
        netsh advfirewall firewall delete rule name="RDP-Tailscale"
        netsh advfirewall firewall add rule name="RDP-Tailscale" `
          dir=in action=allow protocol=TCP localport=3389
        
        # Restart RDP service
        Restart-Service -Name TermService -Force
        
        Write-Host "‚úÖ RDP configuration completed"

  - task: PowerShell@2
    displayName: 'Create RDP User'
    inputs:
      targetType: 'inline'
      script: |
        $password = ConvertTo-SecureString "$(RDP_PASSWORD)" -AsPlainText -Force
        
        # Create user if not exists
        if (-not (Get-LocalUser -Name "$(RDP_USERNAME)" -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name "$(RDP_USERNAME)" -Password $password -AccountNeverExpires
            Write-Host "‚úÖ User $(RDP_USERNAME) created"
        } else {
            Write-Host "‚ö†Ô∏è User $(RDP_USERNAME) already exists"
        }
        
        # Add to groups
        Add-LocalGroupMember -Group "Administrators" -Member "$(RDP_USERNAME)" -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "$(RDP_USERNAME)" -ErrorAction SilentlyContinue
        
        Write-Host "‚úÖ User added to Administrators and Remote Desktop Users groups"
        Write-Host "##vso[task.setvariable variable=RDP_CREDS]User: $(RDP_USERNAME) | Password: $(RDP_PASSWORD)"

  - task: PowerShell@2
    displayName: 'Install Tailscale'
    inputs:
      targetType: 'inline'
      script: |
        $installerPath = "$env:TEMP\tailscale.msi"
        
        Write-Host "üì• Downloading Tailscale version $(TAILSCALE_VERSION)..."
        Invoke-WebRequest -Uri "$(TAILSCALE_MSI_URL)" -OutFile $installerPath
        
        Write-Host "‚öôÔ∏è Installing Tailscale..."
        Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
        
        Remove-Item $installerPath -Force
        Write-Host "‚úÖ Tailscale installation completed"

  - task: PowerShell@2
    displayName: 'Connect Tailscale'
    inputs:
      targetType: 'inline'
      script: |
        $authKey = "$(TAILSCALE_AUTHKEY)"
        $hostname = "az-runner-$(Build.BuildId)"
        
        Write-Host "üîó Connecting to Tailscale with hostname: $hostname"
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$authKey --hostname=$hostname
        
        # Wait for IP assignment
        $tsIP = $null
        $retries = 0
        while (-not $tsIP -and $retries -lt 10) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if (-not $tsIP) {
                Write-Host "‚è≥ Waiting for Tailscale IP... ($retries/10)"
                Start-Sleep -Seconds 5
                $retries++
            }
        }
        
        if (-not $tsIP) {
            Write-Error "‚ùå Tailscale IP not assigned after 10 attempts"
            exit 1
        }
        
        Write-Host "##vso[task.setvariable variable=TAILSCALE_IP]$tsIP"
        Write-Host "‚úÖ Tailscale IP assigned: $tsIP"

  - task: PowerShell@2
    displayName: 'Verify RDP Connection'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "üîç Testing RDP connection on Tailscale IP: $(TAILSCALE_IP)"
        
        $testResult = Test-NetConnection -ComputerName "$(TAILSCALE_IP)" -Port 3389 -WarningAction SilentlyContinue
        
        if ($testResult.TcpTestSucceeded) {
            Write-Host "‚úÖ RDP port 3389 is accessible via Tailscale"
        } else {
            Write-Error "‚ùå RDP port 3389 is not accessible"
            exit 1
        }

  - task: PowerShell@2
    displayName: 'Setup Startup Script and Maintain Connection'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host ""
        Write-Host "================================================"
        Write-Host "üöÄ RDP ACCESS INFORMATION"
        Write-Host "================================================"
        Write-Host "Tailscale Address: $(TAILSCALE_IP)"
        Write-Host "Username: $(RDP_USERNAME)"
        Write-Host "Password: $(RDP_PASSWORD)"
        Write-Host "================================================"
        Write-Host ""
        
        $rdpProfile = "C:\Users\$(RDP_USERNAME)"
        $startupPath = "$rdpProfile\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup"
        $downloadPath = "$startupPath\Downloads.bat"
        
        # Wait for user profile creation (occurs on first login)
        Write-Host "‚è≥ Waiting for RDP user profile to be created..."
        $profileWaitCount = 0
        while (-not (Test-Path $rdpProfile)) {
            $profileWaitCount++
            Write-Host "[$(Get-Date)] Profile not found, waiting... ($profileWaitCount)"
            Start-Sleep -Seconds 30
            
            if ($profileWaitCount -gt 20) {
                Write-Host "‚ö†Ô∏è Profile creation taking too long, continuing anyway..."
                break
            }
        }
        
        # Create startup directory if needed
        if (-not (Test-Path $startupPath)) {
            New-Item -ItemType Directory -Path $startupPath -Force | Out-Null
            Write-Host "üìÅ Created startup directory"
        }
        
        # Download and place the batch file
        try {
            Write-Host "üì• Downloading Downloads.bat..."
            Invoke-WebRequest -Uri "$(DOWNLOAD_BATCH_URL)" -OutFile $downloadPath -UseBasicParsing
            Write-Host "‚úÖ Downloads.bat copied to startup folder: $downloadPath"
            
            # Execute the batch file once
            Write-Host "‚öôÔ∏è Executing Downloads.bat..."
            Start-Process -FilePath "cmd.exe" -ArgumentList "/c `"$downloadPath`"" -WindowStyle Hidden -Wait
            Write-Host "‚úÖ Downloads.bat executed successfully"
        }
        catch {
            Write-Warning "‚ö†Ô∏è Could not download/execute batch file: $_"
        }
        
        # Keep the pipeline job alive
        Write-Host ""
        Write-Host "================================================"
        Write-Host "üñ•Ô∏è  RDP IS NOW READY FOR USE"
        Write-Host "================================================"
        Write-Host ""
        Write-Host "üìã Connection Details:"
        Write-Host "   Address: $(TAILSCALE_IP)"
        Write-Host "   Username: $(RDP_USERNAME)"
        Write-Host "   Password: $(RDP_PASSWORD)"
        Write-Host ""
        Write-Host "‚è±Ô∏è  Pipeline will remain active for 350 minutes"
        Write-Host "üõë To terminate, manually cancel the pipeline run"
        Write-Host ""
        
        $startTime = Get-Date
        $timeoutMinutes = 350
        $lastCheckTime = Get-Date
        
        while (((Get-Date) - $startTime).TotalMinutes -lt $timeoutMinutes) {
            $elapsed = [math]::Round(((Get-Date) - $startTime).TotalMinutes, 1)
            
            # Check if RDP is still accessible every 5 minutes
            if (((Get-Date) - $lastCheckTime).TotalMinutes -gt 5) {
                $testResult = Test-NetConnection -ComputerName "$(TAILSCALE_IP)" -Port 3389 -WarningAction SilentlyContinue
                if ($testResult.TcpTestSucceeded) {
                    Write-Host "[$(Get-Date)] ‚úÖ RDP Active - Elapsed: ${elapsed}min"
                } else {
                    Write-Host "[$(Get-Date)] ‚ùå RDP Connection Lost - Elapsed: ${elapsed}min"
                }
                $lastCheckTime = Get-Date
            }
            
            Start-Sleep -Seconds 60
        }
        
        Write-Host "‚è∞ Timeout reached (350 minutes). RDP session ending."
