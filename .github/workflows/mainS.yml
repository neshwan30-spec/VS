name: Windows RDP with Tailscale

on: workflow_dispatch

jobs:
  rdp-setup:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 hours

    steps:
      # 1. Enable RDP
      - name: Enable RDP and Configure Firewall
        run: |
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          
          # Allow RDP through firewall
          netsh advfirewall firewall delete rule name="RDP" 2>$null
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          
          # Restart RDP service
          Restart-Service TermService -Force

      # 2. Create User with Random Password
      - name: Create RDP User
        id: create_user
        run: |
          # Generate random password
          Add-Type -AssemblyName System.Web
          $password = [System.Web.Security.Membership]::GeneratePassword(12, 2)
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Create user
          New-LocalUser -Name "rdpuser" -Password $securePass -PasswordNeverExpires
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "rdpuser"
          Add-LocalGroupMember -Group "Administrators" -Member "rdpuser"
          
          # Output password
          echo "password=$password" >> $env:GITHUB_OUTPUT
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          Write-Host "User created: rdpuser"

      # 3. Install Tailscale (MSI version)
      - name: Install Tailscale MSI
        run: |
          Write-Host "Downloading Tailscale MSI..."
          $msiUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $msiPath = "$env:TEMP\tailscale.msi"
          
          # Download MSI
          Invoke-WebRequest -Uri $msiUrl -OutFile $msiPath
          
          # Install silently
          Write-Host "Installing Tailscale..."
          Start-Process msiexec.exe -Wait -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart"
          
          # Clean up
          Remove-Item $msiPath -Force
          
          # Wait for service
          Start-Sleep -Seconds 10
          Write-Host "Tailscale installed successfully"

      # 4. Connect Tailscale
      - name: Connect Tailscale
        id: tailscale
        run: |
          # Start Tailscale service if not running
          Start-Service Tailscale -ErrorAction SilentlyContinue
          
          # Wait a moment for service to initialize
          Start-Sleep -Seconds 5
          
          # Connect with auth key
          Write-Host "Connecting to Tailscale..."
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-${{ github.run_id }} --reset
          
          # Get Tailscale IP
          $retryCount = 0
          $maxRetries = 15
          $tailscaleIP = $null
          
          while (-not $tailscaleIP -and $retryCount -lt $maxRetries) {
              $tailscaleIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 2>$null
              if ($tailscaleIP) {
                  break
              }
              Write-Host "Waiting for Tailscale IP... ($retryCount/$maxRetries)"
              $retryCount++
              Start-Sleep -Seconds 3
          }
          
          if (-not $tailscaleIP) {
              Write-Error "Failed to get Tailscale IP"
              exit 1
          }
          
          echo "TAILSCALE_IP=$tailscaleIP" >> $env:GITHUB_ENV
          echo "ip=$tailscaleIP" >> $env:GITHUB_OUTPUT
          
          Write-Host "âœ“ Tailscale connected! IP: $tailscaleIP"

      # 5. Verify RDP
      - name: Verify RDP Connection
        run: |
          Write-Host "Verifying RDP is accessible..."
          $testResult = Test-NetConnection -ComputerName localhost -Port 3389 -WarningAction SilentlyContinue
          
          if ($testResult.TcpTestSucceeded) {
              Write-Host "âœ“ RDP is listening on port 3389"
          } else {
              Write-Error "âœ— RDP is not accessible"
              exit 1
          }

      # 6. Display Connection Information
      - name: Show Connection Details
        run: |
          Write-Host ""
          Write-Host "=================================================="
          Write-Host "           RDP SESSION READY!"
          Write-Host "=================================================="
          Write-Host ""
          Write-Host "ðŸ”— Connect using Microsoft Remote Desktop"
          Write-Host ""
          Write-Host "ðŸ“ IP Address:  $env:TAILSCALE_IP"
          Write-Host "ðŸ‘¤ Username:    rdpuser"
          Write-Host "ðŸ”‘ Password:    $env:RDP_PASSWORD"
          Write-Host ""
          Write-Host "â° Session will auto-end in 6 hours"
          Write-Host ""
          Write-Host "=================================================="
          Write-Host ""
          
          # Save credentials to file
          $credFile = "$env:RUNNER_TEMP\rdp_credentials.txt"
          @"
RDP Connection Details
=====================
IP Address: $env:TAILSCALE_IP
Username:   rdpuser
Password:   $env:RDP_PASSWORD
Session ID: ${{ github.run_id }}
Generated:  $(Get-Date)
"@ | Out-File -FilePath $credFile
          
          Write-Host "Credentials saved to: $credFile"

      # 7. Keep Alive
      - name: Keep Session Alive
        run: |
          Write-Host ""
          Write-Host "ðŸ”„ Keeping session active..."
          Write-Host "Press 'Cancel workflow' in GitHub to stop"
          Write-Host ""
          
          $startTime = Get-Date
          $endTime = $startTime.AddMinutes(355)  # 5 minutes before timeout
          
          while ((Get-Date) -lt $endTime) {
              $remaining = $endTime - (Get-Date)
              $hours = [math]::Floor($remaining.TotalHours)
              $minutes = [math]::Floor($remaining.TotalMinutes % 60)
              
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Session active - $($hours)h $($minutes)m remaining"
              
              # Check Tailscale status
              & "C:\Program Files\Tailscale\tailscale.exe" status --active 2>$null
              
              # Sleep for 1 minute
              Start-Sleep -Seconds 60
          }
          
          Write-Host "Session ending soon..."
