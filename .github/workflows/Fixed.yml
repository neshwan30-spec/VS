name: Windows RDP with Tailscale

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Session Duration'
        required: false
        default: '6 hours'

jobs:
  rdp-setup:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: Display Start Message
      run: |
        Write-Host "=========================================="
        Write-Host "   WINDOWS RDP SETUP WITH TAILSCALE"
        Write-Host "=========================================="
        Write-Host "Duration: ${{ github.event.inputs.duration }}"
        Write-Host "=========================================="
    
    - name: Enable RDP
      run: |
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Create user
        $password = "TempPass123!"
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force
        New-LocalUser -Name "RDPUser" -Password $securePass
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
        
        Write-Host "RDP enabled. Username: RDPUser, Password: TempPass123!"
    
    - name: Install Tailscale
      run: |
        Invoke-WebRequest -Uri "https://dl.tailscale.com/stable/tailscale-setup-latest-amd64.exe" -OutFile "$env:TEMP\tailscale.exe"
        Start-Process "$env:TEMP\tailscale.exe" -ArgumentList "/S" -Wait
    
    - name: Display Connection Info
      run: |
        Write-Host "`n"
        Write-Host "╔══════════════════════════════════╗"
        Write-Host "║       CONNECTION READY!         ║"
        Write-Host "╠══════════════════════════════════╣"
        Write-Host "║ Username: RDPUser               ║"
        Write-Host "║ Password: TempPass123!          ║"
        Write-Host "║                                  ║"
        Write-Host "║ Wait for Tailscale IP...        ║"
        Write-Host "╚══════════════════════════════════╝"
        Write-Host "`n"
        
        # Keep session alive
        while ($true) {
            Write-Host "[$(Get-Date)] Session active..."
            Start-Sleep -Seconds 30
        }
