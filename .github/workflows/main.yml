name: Secure Tailscale Setup

on:
  workflow_dispatch:
    inputs:
      use_temp_token:
        description: 'Use temporary token'
        type: boolean
        default: true

jobs:
  setup:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Get Tailscale Token (Secure)
      id: get-token
      shell: powershell
      run: |
        # Prefer ephemeral tokens for CI/CD
        $token = "${{ secrets.TAILSCALE_EPHEMERAL_TOKEN }}"
        
        if ([string]::IsNullOrEmpty($token)) {
          # Fallback to regular token
          $token = "${{ secrets.TAILSCALE_AUTH_TOKEN }}"
        }
        
        if ([string]::IsNullOrEmpty($token)) {
          Write-Error "No Tailscale token found in secrets!"
          exit 1
        }
        
        # Mask token in logs (GitHub does this automatically for secrets)
        echo "token=$token" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        
    - name: Setup Tailscale
      env:
        TS_AUTHKEY: ${{ steps.get-token.outputs.token }}
      run: |
        # Install and connect
        msiexec /i "https://pkgs.tailscale.com/stable/tailscale-setup.msi" /quiet /norestart
        timeout /t 15
        "C:\Program Files\Tailscale\tailscale.exe" up --auth-key $env:TS_AUTHKEY
