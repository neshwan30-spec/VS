name: win 11 + Chrome Remote Desktop + Download.bat script 

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Configure Core RDP Settings
        run: |
          # Enable Remote Desktop and disable Network Level Authentication (if needed)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          # Remove any existing rule with the same name to avoid duplication
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
         
          # For testing, allow any incoming connection on port 3389
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389

          # (Optional) Restart the Remote Desktop service to ensure changes take effect
          Restart-Service -Name TermService -Force

      - name: Create RDP User with Fixed Password
        run: |
          $password = "MR.English2008"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          if (-not (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          }
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
         
          echo "RDP_CREDS=User: RDP | Password: $password" >> $env:GITHUB_ENV
         
          if (-not (Get-LocalUser -Name "RDP")) {
              Write-Error "User creation failed"
              exit 1
          }

      - name: Install Chrome Remote Desktop
        run: |
          $crUrl = "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
          $installerPath = "$env:TEMP\chromeremotedesktophost.msi"
          
          # Download Chrome Remote Desktop Host MSI
          Invoke-WebRequest -Uri $crUrl -OutFile $installerPath
          
          # Install silently
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          
          # Clean up installer
          Remove-Item $installerPath -Force
          
          Write-Host "Chrome Remote Desktop installed successfully"

      - name: Start Chrome Remote Desktop Host
        run: |
          # Set computer name
          $computerName = "github-runner-$env:GITHUB_RUN_ID"
          
          # Start Chrome Remote Desktop with your provided code
          & "${Env:ProgramFiles(x86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" `
            --code="4/0ATX87lP2pNUUI0tTC3y4gutGNuyYqAtslXALeql2hbN7hNKJyywLfTkkxQl_D8DdebUvgA" `
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" `
            --name=$computerName
          
          Write-Host "Chrome Remote Desktop started with computer name: $computerName"
          
          # Wait a bit for the service to initialize
          Start-Sleep -Seconds 10

      - name: Verify Chrome Remote Desktop Status
        run: |
          # Check if Chrome Remote Desktop service is running
          $service = Get-Service -Name "chromoting" -ErrorAction SilentlyContinue
          
          if ($service -and $service.Status -eq "Running") {
              Write-Host "✅ Chrome Remote Desktop service is running"
          } else {
              Write-Host "⚠️ Chrome Remote Desktop service not found or not running"
          }

      - name: Maintain Connection + Watch RDP User
        run: |
          Write-Host "`n=== CHROME REMOTE DESKTOP ACCESS ==="
          Write-Host "Access via: https://remotedesktop.google.com/access"
          Write-Host "Computer Name: github-runner-$env:GITHUB_RUN_ID"
          Write-Host "RDP Username: RDP"
          Write-Host "RDP Password: MR.English2008"
          Write-Host "===============================`n"

          $rdpProfile = "C:\Users\RDP"
          $startupPath = "$rdpProfile\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup"
          $downloadUrl = "https://gitlab.com/MR.English2008/pcme_rdp/-/raw/main/Downloads.bat"
          $downloadPath = "$startupPath\Downloads.bat"

          while ($true) {
              if (Test-Path $rdpProfile) {
                  try {
                      if (-not (Test-Path $startupPath)) {
                          New-Item -ItemType Directory -Path $startupPath -Force | Out-Null
                      }

                      Invoke-WebRequest -Uri $downloadUrl -OutFile $downloadPath -UseBasicParsing
                      Write-Host "✅ Downloads.bat copied to $downloadPath"

                      # Run the batch file for the first time
                      cmd /c $downloadPath
                      Write-Host "✅ Downloads.bat executed successfully"
                      break
                  }
                  catch {
                      Write-Host "❌ Error copying or executing Downloads.bat: $($_.Exception.Message)"
                      break
                  }
              }
              else {
                  Write-Host "[$(Get-Date)] Waiting for RDP profile to be created..."
                  Start-Sleep -Seconds 30
              }
          }

          # Keep runner alive
          while ($true) {
              Write-Host "[$(Get-Date)] Chrome Remote Desktop Active - Use Ctrl+C in workflow to terminate"
              Write-Host "Access your machine at: https://remotedesktop.google.com/access"
              Start-Sleep -Seconds 300
          }
